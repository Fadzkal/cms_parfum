<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard | Prime Fragrance</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- VARIABLES (Match Landing Page Theme) --- */
        :root {
            --navy-dark: #0F172A;    /* Sidebar BG */
            --navy-light: #1E293B;   /* Hover BG */
            --blue-accent: #3B82F6;  /* Primary Action */
            --gold-accent: #F59E0B;  /* Secondary Highlight */
            --green-accent: #10B981; /* Success */
            --red-accent: #EF4444;   /* Danger */
            --orange-accent: #F97316; /* Warning */
            --bg-main: #F1F5F9;      /* Body Background */
            --white: #FFFFFF;
            --text-dark: #334155;
            --text-gray: #64748B;
            --border: #E2E8F0;
            --sidebar-width: 260px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-dark);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR (Fixed Left) --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--navy-dark);
            color: var(--white);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 100;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 12px;
        }
        .logo-icon { font-size: 1.5rem; color: var(--blue-accent); }
        .logo-text { font-weight: 800; font-size: 1.1rem; letter-spacing: 0.5px; }

        .nav-menu { flex: 1; padding: 20px 15px; overflow-y: auto; }
        .menu-label {
            padding: 0 15px; margin-bottom: 10px; margin-top: 20px;
            font-size: 0.75rem; text-transform: uppercase; color: var(--text-gray); letter-spacing: 1px; font-weight: 700;
        }
        
        .nav-link {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 15px; border-radius: 10px;
            color: #CBD5E1; text-decoration: none;
            font-weight: 500; transition: var(--transition);
            margin-bottom: 5px;
            cursor: pointer;
        }
        .nav-link:hover { background-color: rgba(255,255,255,0.05); color: var(--white); transform: translateX(5px); }
        .nav-link.active { background-color: var(--blue-accent); color: var(--white); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .nav-link i { width: 20px; text-align: center; font-size: 1.1rem; }

        .user-panel {
            padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);
            background-color: rgba(0,0,0,0.2);
        }
        .user-info { font-weight: 700; font-size: 0.9rem; color: var(--white); }
        .user-role { font-size: 0.8rem; color: var(--text-gray); margin-bottom: 10px; }
        .btn-logout { 
            color: #EF4444; text-decoration: none; font-size: 0.85rem; 
            display: flex; align-items: center; gap: 8px; font-weight: 600; transition: 0.2s; 
        }
        .btn-logout:hover { color: #FCA5A5; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            position: relative;
        }

        /* Mobile Header */
        .mobile-header {
            display: none; background: var(--white); padding: 15px 20px;
            justify-content: space-between; align-items: center; box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border);
        }

        .top-header {
            background: var(--white); padding: 20px 40px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .page-title h1 { font-size: 1.5rem; color: var(--navy-dark); font-weight: 800; }
        .page-title p { color: var(--text-gray); font-size: 0.9rem; margin-top: 5px; }
        
        .dashboard-content {
            padding: 40px; overflow-y: auto; flex: 1;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px; margin-bottom: 40px;
        }
        .kpi-card {
            background: var(--white); padding: 25px; border-radius: 16px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            position: relative; overflow: hidden; transition: var(--transition);
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: var(--blue-accent); }
        
        .kpi-icon {
            position: absolute; right: 20px; top: 20px;
            width: 50px; height: 50px; background: #EFF6FF; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: var(--blue-accent);
        }
        .kpi-label { color: var(--text-gray); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 2rem; font-weight: 800; color: var(--navy-dark); margin: 10px 0; }
        .kpi-trend { font-size: 0.85rem; display: flex; align-items: center; gap: 5px; font-weight: 600; }
        .trend-up { color: #10B981; } .trend-down { color: #EF4444; }
        
        /* Charts Area */
        .charts-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 40px;
        }
        .chart-container {
            background: var(--white); padding: 25px; border-radius: 16px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .card-title { font-size: 1.1rem; font-weight: 700; color: var(--navy-dark); }

        /* Table */
        .table-container {
            background: var(--white); padding: 0; border-radius: 16px;
            box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden;
            margin-bottom: 30px;
        }
        .table-header { padding: 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 25px; background: #F8FAFC; color: var(--text-gray); font-weight: 700; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 15px 25px; border-bottom: 1px solid var(--border); color: var(--text-dark); font-size: 0.95rem; font-weight: 500; }
        tr:last-child td { border-bottom: none; }
        
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-ok { background: #DCFCE7; color: #166534; }
        .status-warn { background: #FEF3C7; color: #92400E; }
        .status-err { background: #FEE2E2; color: #991B1B; }

        /* Image Gallery in Table */
        .image-gallery {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .gallery-item {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gallery-count {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Buttons & Inputs */
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; transition: var(--transition); display: inline-flex; align-items: center; gap: 8px;
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--navy-dark); color: var(--white); }
        .btn-primary:hover { background: var(--blue-accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-gray); }
        .btn-outline:hover { border-color: var(--text-dark); color: var(--text-dark); }
        .btn-success { background: var(--green-accent); color: var(--white); }
        .btn-success:hover { background: #059669; transform: translateY(-2px); }
        .btn-pdf { background: #EF4444; color: var(--white); }
        .btn-pdf:hover { background: #DC2626; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            padding: 20px;
        }
        .modal-box {
            background: var(--white); width: 500px; max-width: 90vw; max-height: 90vh;
            padding: 30px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--navy-dark); font-size: 0.9rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;
            font-family: inherit; font-size: 0.95rem; transition: var(--transition);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { 
            border-color: var(--blue-accent); outline: none; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-textarea { resize: vertical; min-height: 80px; }

        /* Image Modal */
        .image-modal {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        .image-modal-header {
            padding: 15px 20px;
            background: var(--navy-dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .image-modal-body {
            padding: 0;
            max-width: 80vw;
            max-height: 70vh;
            overflow: auto;
        }
        .image-modal img {
            width: 100%;
            height: auto;
            display: block;
        }
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        /* Alert System */
        .alert-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            max-width: 400px;
        }
        .alert {
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border-left: 4px solid var(--green-accent);
        }
        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border-left: 4px solid var(--red-accent);
        }
        .alert-warning {
            background: #FEF3C7;
            color: #92400E;
            border-left: 4px solid var(--orange-accent);
        }

        /* PDF Loading Overlay */
        .pdf-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            color: white;
        }
        .pdf-loading .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* New Feature Styles */
        .task-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-asset {
            font-weight: 700;
            color: var(--navy-dark);
        }
        .task-prio {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .task-desc {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        .task-meta {
            display: flex;
            gap: 15px;
        }
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--text-gray);
        }
        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .stat-card.warning {
            border-color: var(--orange-accent);
        }
        .stat-card.danger {
            border-color: var(--red-accent);
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--navy-dark);
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { position: absolute; transform: translateX(-100%); height: 100%; }
            .sidebar.active { transform: translateX(0); box-shadow: 100vw 0 0 rgba(0,0,0,0.5); }
            .mobile-header { display: flex; }
            .top-header { display: none; }
            .charts-grid { grid-template-columns: 1fr; }
            .dashboard-content { padding: 20px; }
        }

        @media (max-width: 768px) {
            .table-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .task-meta { flex-direction: column; gap: 8px; }
        }

        @media (max-width: 480px) {
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    
    <div class="mobile-header">
        <div class="logo-text" style="color: var(--navy-dark);"><i class="fas fa-flask"></i> PrimeFragrance</div>
        <button class="btn-outline" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-flask logo-icon"></i>
            <div class="logo-text">PrimeFragrance</div>
        </div>
        
        <div class="nav-menu">
            <div class="menu-label">Overview</div>
            <a href="#" class="nav-link active"><i class="fas fa-chart-pie"></i> Dashboard</a>
            
            <div class="menu-label">Administrasi</div>
            <a href="#" class="nav-link" onclick="openUserModal()"><i class="fas fa-user-plus"></i> Tambah User</a>
            <a href="#" class="nav-link" onclick="openAssetModal()"><i class="fas fa-plus-circle"></i> Tambah Aset</a>
            
            <div class="menu-label">Laporan</div>
            <a href="#" class="nav-link" onclick="generateFullReport()"><i class="fas fa-file-alt"></i> Laporan Lengkap</a>
            <a href="#" class="nav-link" onclick="exportAllData()"><i class="fas fa-download"></i> Export Semua Data</a>
            <a href="#" class="nav-link" onclick="generatePDFReport()"><i class="fas fa-file-pdf"></i> Download PDF</a>
        </div>
        
        <div class="user-panel">
            <div class="user-info" id="userName">Manager</div>
            <div class="user-role">Head of Engineering</div>
            <a href="/logout" class="btn-logout"><i class="fas fa-right-from-bracket"></i> Logout</a>
        </div>
    </div>

    <div class="main-content">
        <header class="top-header">
            <div class="page-title">
                <h1>Executive Dashboard</h1>
                <p>Pantau kesehatan aset dan efisiensi produksi secara real-time.</p>
            </div>
            <div style="color: var(--text-gray); font-weight: 600; font-size: 0.9rem;">
                <i class="far fa-calendar-alt"></i> <span id="dateNow"></span>
            </div>
        </header>

        <div class="dashboard-content">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fas fa-stopwatch"></i></div>
                    <div class="kpi-label">MTTR Rata-rata</div>
                    <div class="kpi-value" id="mttrValue">--</div>
                    <div class="kpi-trend trend-up">
                        <i class="fas fa-arrow-down"></i> Efisiensi naik 12%
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="color: #10B981; background: #DCFCE7;"><i class="fas fa-check-circle"></i></div>
                    <div class="kpi-label">Kepatuhan PM</div>
                    <div class="kpi-value" id="pmCompliance">--%</div>
                    <div class="kpi-trend" style="color: var(--text-gray);">
                        Target Bulanan: 90%
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="color: #EF4444; background: #FEE2E2;"><i class="fas fa-triangle-exclamation"></i></div>
                    <div class="kpi-label">Aset Kritis</div>
                    <div class="kpi-value" id="problemAsset" style="font-size: 1.5rem;">Loading...</div>
                    <div class="kpi-trend trend-down">
                        Perlu perhatian segera
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon" style="color: #F59E0B; background: #FEF3C7;"><i class="fas fa-list-check"></i></div>
                    <div class="kpi-label">WO Aktif</div>
                    <div class="kpi-value" id="activeWo">--</div>
                    <div class="kpi-trend" style="color: var(--text-gray);">
                        Sedang dikerjakan
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="card-header">
                        <div class="card-title">Statistik Work Order (Mingguan)</div>
                        <button class="btn-outline" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportWOStats(currentWoStats)"><i class="fas fa-download"></i> Export</button>
                    </div>
                    <canvas id="woChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="card-header">
                        <div class="card-title">Status Kesehatan Aset</div>
                    </div>
                    <canvas id="assetChart"></canvas>
                </div>
            </div>

            <!-- New Features Section -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="card-header">
                        <div class="card-title">Analisis OEE (Overall Equipment Effectiveness)</div>
                        <button class="btn-outline" onclick="calculateOEE()" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-calculator"></i> Hitung OEE
                        </button>
                    </div>
                    <div id="oeeContainer">
                        <canvas id="oeeChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="card-header">
                        <div class="card-title">Risk Assessment & Predictive Maintenance</div>
                        <button class="btn-outline" onclick="loadRiskAssessment()" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div id="riskAssessmentContainer">
                        <div style="padding: 20px; text-align: center; color: var(--text-gray);">
                            Memuat assessment risiko...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Energy Monitoring Section -->
            <div class="table-container" style="margin-top: 30px;">
                <div class="table-header">
                    <div class="card-title">Energy Consumption Monitoring</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" onclick="loadEnergyAnalysis()">
                            <i class="fas fa-bolt"></i> Analisis Energi
                        </button>
                        <button class="btn btn-primary" onclick="showEnergyModal()">
                            <i class="fas fa-plus"></i> Catat Konsumsi
                        </button>
                    </div>
                </div>
                <div id="energyAnalysisContainer">
                    <div style="padding: 30px; text-align: center; color: var(--text-gray);">
                        <i class="fas fa-bolt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div>Klik "Analisis Energi" untuk melihat data konsumsi</div>
                    </div>
                </div>
            </div>

            <!-- Cost Analysis Section -->
            <div class="table-container" style="margin-top: 30px;">
                <div class="table-header">
                    <div class="card-title">Maintenance Cost Analysis</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" onclick="loadCostAnalysis()">
                            <i class="fas fa-chart-line"></i> Analisis Biaya
                        </button>
                        <button class="btn btn-primary" onclick="showBudgetModal()">
                            <i class="fas fa-coins"></i> Set Budget
                        </button>
                    </div>
                </div>
                <div id="costAnalysisContainer">
                    <div style="padding: 30px; text-align: center; color: var(--text-gray);">
                        <i class="fas fa-chart-pie" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div>Klik "Analisis Biaya" untuk melihat breakdown biaya maintenance</div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <div class="card-title">Detail Aset Produksi</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" onclick="exportAssetDetail(currentAssets)"><i class="fas fa-download"></i> Export Data</button>
                        <button class="btn btn-primary" onclick="loadDashboard()"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                        <button class="btn btn-pdf" onclick="generatePDFReport()"><i class="fas fa-file-pdf"></i> Download PDF</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nama Aset</th>
                                <th>Lokasi</th>
                                <th>Status</th>
                                <th>Total Breakdown</th>
                                <th>Efisiensi OEE</th>
                            </tr>
                        </thead>
                        <tbody id="assetTableBody">
                            <tr><td colspan="5" style="text-align:center; padding: 30px;">Memuat Data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <div class="card-title">Riwayat Work Order Lengkap</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" onclick="exportWOHistory(currentWOHistory)"><i class="fas fa-download"></i> Export Data</button>
                        <button class="btn btn-success" onclick="loadWorkOrderHistory()"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Aset</th>
                                <th>Jenis / Prioritas</th>
                                <th>Status</th>
                                <th>Teknisi</th>
                                <th>Supervisor</th>
                                <th>Komponen Rusak</th>
                                <th>Akar Masalah</th>
                                <th>Foto</th>
                                <th>Waktu Troble</th>
                                <th>Durasi Perbaikan</th>
                            </tr>
                        </thead>
                        <tbody id="woHistoryTableBody">
                            <tr><td colspan="10" style="text-align:center; padding: 30px;">Memuat Riwayat WO...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>

    <!-- User Registration Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-box">
            <h2 style="color: var(--navy-dark); margin-bottom: 5px;">Tambah Pengguna Baru</h2>
            <p style="color: var(--text-gray); margin-bottom: 25px;">Isi data lengkap untuk membuat akun staf.</p>
            
            <form id="regForm">
                <div class="form-group">
                    <label class="form-label">Nama Lengkap</label>
                    <input type="text" id="regName" class="form-input" placeholder="Contoh: Budi Santoso" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="regUsername" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="regPass" class="form-input" required>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="regRole" class="form-select">
                            <option value="Operator">Operator</option>
                            <option value="Teknisi">Teknisi</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Manager">Manager</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Departemen</label>
                        <input type="text" id="regDept" class="form-input" placeholder="Contoh: Produksi" required>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('userModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Asset Registration Modal -->
    <div class="modal-overlay" id="assetModal">
        <div class="modal-box">
            <h2 style="color: var(--navy-dark); margin-bottom: 5px;">Tambah Aset Baru</h2>
            <p style="color: var(--text-gray); margin-bottom: 25px;">Daftarkan aset/mesin baru ke sistem.</p>
            
            <form id="assetForm">
                <div class="form-group">
                    <label class="form-label">Nama Aset</label>
                    <input type="text" id="assetName" class="form-input" placeholder="Contoh: Filling Machine 02" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Lokasi</label>
                    <input type="text" id="assetLocation" class="form-input" placeholder="Contoh: Lini Pengisian" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Jenis Mesin</label>
                        <select id="assetType" class="form-select">
                            <option value="mixing">Mixing Tank</option>
                            <option value="filling">Filling Machine</option>
                            <option value="conveyor">Conveyor</option>
                            <option value="labeling">Labeling Machine</option>
                            <option value="packaging">Packaging</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status Awal</label>
                        <select id="assetStatus" class="form-select">
                            <option value="Operasi Normal">Operasi Normal</option>
                            <option value="Perlu Perhatian">Perlu Perhatian</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Komponen Kritis (pisahkan dengan koma)</label>
                    <textarea id="assetComponents" class="form-textarea" placeholder="Contoh: Motor, Bearing, Sensor, Nozzle"></textarea>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('assetModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Aset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal-overlay" id="imageModal">
        <div class="image-modal">
            <div class="image-modal-header">
                <span id="imageModalTitle">Foto WO</span>
                <button class="close-btn" onclick="closeModal('imageModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="image-modal-body">
                <img id="modalImage" src="" alt="Work Order Image">
            </div>
        </div>
    </div>

    <!-- OEE Calculation Modal -->
    <div class="modal-overlay" id="oeeModal">
        <div class="modal-box">
            <h3 style="color: var(--navy-dark); margin-bottom: 5px;">Hitung OEE</h3>
            <p style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 20px;">
                Hitung Overall Equipment Effectiveness untuk mesin
            </p>
            
            <form id="oeeForm">
                <div class="form-group">
                    <label class="form-label">Pilih Mesin</label>
                    <select id="oeeAsset" class="form-input" required>
                        <option value="">-- Pilih Aset --</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Waktu Produksi Direncanakan (jam)</label>
                        <input type="number" id="plannedTime" class="form-input" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Waktu Produksi Aktual (jam)</label>
                        <input type="number" id="actualTime" class="form-input" step="0.1" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Ideal Cycle Time (menit/unit)</label>
                        <input type="number" id="cycleTime" class="form-input" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Unit Diproduksi</label>
                        <input type="number" id="totalUnits" class="form-input" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Unit yang Baik (Good Units)</label>
                    <input type="number" id="goodUnits" class="form-input" required>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('oeeModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Hitung OEE</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Energy Consumption Modal -->
    <div class="modal-overlay" id="energyModal">
        <div class="modal-box">
            <h3 style="color: var(--navy-dark); margin-bottom: 5px;">Catat Konsumsi Energi</h3>
            
            <form id="energyForm">
                <div class="form-group">
                    <label class="form-label">Pilih Mesin</label>
                    <select id="energyAsset" class="form-input" required>
                        <option value="">-- Pilih Aset --</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Konsumsi Energi (kWh)</label>
                        <input type="number" id="energyConsumption" class="form-input" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Durasi (jam)</label>
                        <input type="number" id="energyDuration" class="form-input" step="0.1" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tanggal & Waktu</label>
                    <input type="datetime-local" id="energyTimestamp" class="form-input" required>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('energyModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Setting Modal -->
    <div class="modal-overlay" id="budgetModal">
        <div class="modal-box">
            <h3 style="color: var(--navy-dark); margin-bottom: 5px;">Tetapkan Budget Maintenance</h3>
            
            <form id="budgetForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Tahun</label>
                        <select id="budgetYear" class="form-input" required>
                            <option value="">-- Pilih Tahun --</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quarter</label>
                        <select id="budgetQuarter" class="form-input" required>
                            <option value="">-- Pilih Quarter --</option>
                            <option value="1">Q1</option>
                            <option value="2">Q2</option>
                            <option value="3">Q3</option>
                            <option value="4">Q4</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Jumlah Budget (IDR)</label>
                    <input type="number" id="budgetAmount" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Departemen</label>
                    <input type="text" id="budgetDepartment" class="form-input" value="Maintenance" required>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('budgetModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Set Budget</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PDF Loading Overlay -->
    <div class="pdf-loading" id="pdfLoading">
        <div class="spinner"></div>
        <h3>Membuat Laporan PDF...</h3>
        <p>Proses ini mungkin memakan waktu beberapa detik</p>
    </div>

    <!-- Alert Area -->
    <div id="alertArea" class="alert-area"></div>

    <script>
        // Deklarasi Global
        let woChartInstance = null;
        let assetChartInstance = null;
        let oeeChartInstance = null;
        let currentWoStats = {}; 
        let currentAssets = []; 
        let currentWOHistory = [];

        // Init Data
        document.getElementById('userName').textContent = sessionStorage.getItem('user_name') || 'Manager';
        document.getElementById('dateNow').textContent = new Date().toLocaleDateString('id-ID', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        // Mobile Toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Alert System
        function showAlert(message, type = 'success') {
            const alertArea = document.getElementById('alertArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            let icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            alertDiv.innerHTML = `
                <i class="fas ${icon}"></i>
                <div>${message}</div>
            `;
            
            alertArea.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => {
                    alertDiv.remove();
                }, 300);
            }, 5000);
        }

        async function loadDashboard() {
            try {
                // Fetch data dari API
                const [kpiRes, dashRes, assetRes] = await Promise.all([
                    fetch('/api/kpi/assets'),
                    fetch('/api/kpi/dashboard'),
                    fetch('/api/assets/detail')
                ]);

                const kpiData = await kpiRes.json();
                const dashData = await dashRes.json();
                const assets = await assetRes.json();
                
                // Simpan data ke variabel global
                currentWoStats = kpiData.wo_stats || {}; 
                currentAssets = assets; 

                // Update KPI
                document.getElementById('pmCompliance').textContent = kpiData.pm_compliance.toFixed(1) + '%';
                document.getElementById('problemAsset').textContent = kpiData.problem_asset; 
                document.getElementById('mttrValue').textContent = dashData.mttr_minutes.toFixed(1) + ' m';
                document.getElementById('activeWo').textContent = dashData.active_work_orders;

                // Update Charts
                updateCharts(currentWoStats, dashData);

                // Update Table
                renderTable(assets);
                
                // Load WO History
                loadWorkOrderHistory(); 
                
                // Load new features
                await loadOEEAnalysis();
                await loadRiskAssessment();
                await loadEnergyAnalysis();
                await loadCostAnalysis();

            } catch (e) { 
                console.error("Error loading dashboard:", e); 
                document.getElementById('problemAsset').textContent = "API Error";
                showAlert('Gagal memuat data dashboard', 'error');
            }
        }
        
        // Load Work Order History
        async function loadWorkOrderHistory() {
            try {
                const woRes = await fetch('/api/work_orders/history'); 
                const woHistory = await woRes.json();
                
                currentWOHistory = woHistory; 

                const woTableBody = document.getElementById('woHistoryTableBody');
                woTableBody.innerHTML = ''; 

                if (woHistory.length === 0) {
                    woTableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">Tidak ada riwayat Work Order.</td></tr>';
                    return;
                }

                woHistory.forEach(wo => {
                    let statusBadge = '';
                    if (wo.status === 'Ditutup') statusBadge = '<span class="status-badge status-ok">DITUTUP</span>';
                    else if (wo.status === 'Dalam Pengerjaan' || wo.status === 'Ditugaskan') statusBadge = '<span class="status-badge status-warn">PROSES</span>';
                    else if (wo.status === 'Baru') statusBadge = '<span class="status-badge status-err">BARU</span>';
                    else if (wo.status === 'Selesai') statusBadge = '<span class="status-badge status-warn">VERIFIKASI</span>';

                    // Handle photos
                    let photoGallery = '<div style="color: var(--text-gray); font-size: 0.8rem;">Tidak ada foto</div>';
                    const photos = wo.completion_photos || wo.photos || [];
                    
                    if (photos.length > 0) {
                        const displayPhotos = photos.slice(0, 3);
                        photoGallery = `
                            <div class="image-gallery">
                                ${displayPhotos.map((photo, index) => `
                                    <div class="gallery-item" onclick="openImageModal('/static/uploads/${photo}', '${wo.asset_name} - Foto ${index + 1}')">
                                        <img src="/static/uploads/${photo}" alt="WO Image ${index + 1}" onerror="this.style.display='none'">
                                        ${index === 2 && photos.length > 3 ? 
                                            `<div class="gallery-count">+${photos.length - 3}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    woTableBody.innerHTML += `
                        <tr>
                            <td style="font-weight:700;">${wo.asset_name}</td>
                            <td>${wo.type} / ${wo.priority}</td>
                            <td>${statusBadge}</td>
                            <td style="color:var(--navy-dark);">${wo.technician || wo.assigned_to || 'N/A'}</td>
                            <td style="color:var(--text-gray);">${wo.supervisor || 'N/A'}</td>
                            <td>${wo.component_failed || 'N/A'}</td>
                            <td>${wo.root_cause || 'N/A'}</td>
                            <td>${photoGallery}</td>
                            <td style="font-size:0.85rem; color:var(--text-gray);">${wo.requested_at}</td>
                            <td style="font-weight:700;">${wo.duration}</td>
                        </tr>
                    `;
                });

            } catch (e) {
                console.error("Gagal memuat riwayat Work Order:", e);
                document.getElementById('woHistoryTableBody').innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px; color:var(--red-accent);">Gagal memuat data WO.</td></tr>';
            }
        }

        // Export Functions
        function exportWOStats(woStats) {
            if (Object.keys(woStats).length === 0) {
                showAlert("Data Work Order belum termuat atau kosong.", 'warning');
                return;
            }

            const data = [
                ['Status', 'Jumlah WO'],
                ['Baru', woStats.new],
                ['Proses', woStats.in_progress],
                ['Selesai', woStats.completed],
                ['Ditutup', woStats.closed]
            ];
            
            const csvContent = data.map(e => e.join(";")).join("\n");
            downloadCSV(csvContent, 'statistik_work_order_mingguan.csv');
            showAlert('Data Work Order berhasil diexport ke CSV!', 'success');
        }
        
        function exportWOHistory(woHistory) {
            if (woHistory.length === 0) {
                showAlert("Tidak ada data riwayat Work Order yang tersedia untuk diexport.", 'warning');
                return;
            }

            let csvContent = "Aset;Jenis;Prioritas;Status;Teknisi;Supervisor;Komponen Rusak;Akar Masalah;Waktu Troble;Durasi Perbaikan\n";
            
            woHistory.forEach(wo => {
                const row = [
                    wo.asset_name,
                    wo.type,
                    wo.priority,
                    wo.status,
                    wo.technician || 'N/A',
                    wo.supervisor || 'N/A',
                    wo.component_failed || 'N/A',
                    wo.root_cause || 'N/A',
                    wo.requested_at,
                    wo.duration
                ];
                csvContent += row.join(";") + "\n";
            });
            
            downloadCSV(csvContent, 'riwayat_work_order_lengkap.csv');
            showAlert('Data Riwayat Work Order berhasil diexport ke CSV!', 'success');
        }

        function exportAssetDetail(assets) {
            if (assets.length === 0) {
                showAlert("Tidak ada data aset yang tersedia untuk diexport.", 'warning');
                return;
            }

            let csvContent = "Nama Aset;Lokasi;Status;Total Breakdown;Efisiensi OEE\n";
            
            assets.forEach(asset => {
                const efficiency = parseFloat(asset.efficiency) || 0;
                const row = [
                    asset.name,
                    asset.location,
                    asset.status,
                    asset.breakdown_count,
                    efficiency.toFixed(1).replace('.', ',') + '%' 
                ];
                csvContent += row.join(";") + "\n";
            });
            
            downloadCSV(csvContent, 'detail_aset_produksi.csv');
            showAlert('Data Detail Aset berhasil diexport ke CSV!', 'success');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Generate Full Report
        async function generateFullReport() {
            showAlert('Membuat laporan lengkap...', 'warning');
            
            try {
                // Collect all data
                const [kpiRes, dashRes, assetRes, woHistoryRes] = await Promise.all([
                    fetch('/api/kpi/assets'),
                    fetch('/api/kpi/dashboard'),
                    fetch('/api/assets/detail'),
                    fetch('/api/work_orders/history')
                ]);

                const kpiData = await kpiRes.json();
                const dashData = await dashRes.json();
                const assets = await assetRes.json();
                const woHistory = await woHistoryRes.json();

                // Create comprehensive report
                let reportContent = `LAPORAN LENGKAP MAINTENANCE MANAGEMENT SYSTEM\n`;
                reportContent += `Prime Fragrance Technologies\n`;
                reportContent += `Tanggal: ${new Date().toLocaleDateString('id-ID')}\n\n`;
                
                reportContent += `=== KPI UTAMA ===\n`;
                reportContent += `MTTR Rata-rata: ${dashData.mttr_minutes.toFixed(1)} menit\n`;
                reportContent += `Kepatuhan PM: ${kpiData.pm_compliance.toFixed(1)}%\n`;
                reportContent += `Aset Bermasalah: ${kpiData.problem_asset}\n`;
                reportContent += `WO Aktif: ${dashData.active_work_orders}\n\n`;
                
                reportContent += `=== STATISTIK WORK ORDER ===\n`;
                reportContent += `Baru: ${kpiData.wo_stats.new}\n`;
                reportContent += `Dalam Proses: ${kpiData.wo_stats.in_progress}\n`;
                reportContent += `Selesai: ${kpiData.wo_stats.completed}\n`;
                reportContent += `Ditutup: ${kpiData.wo_stats.closed}\n\n`;
                
                reportContent += `=== RIWAYAT WORK ORDER TERBARU ===\n`;
                woHistory.slice(0, 10).forEach(wo => {
                    reportContent += `${wo.asset_name} | ${wo.type} | ${wo.status} | ${wo.duration}\n`;
                });
                
                reportContent += `\n=== TOTAL DATA ===\n`;
                reportContent += `Jumlah Aset: ${assets.length}\n`;
                reportContent += `Jumlah WO dalam Sistem: ${woHistory.length}\n`;

                downloadCSV(reportContent, 'laporan_lengkap_mms.txt');
                showAlert('Laporan lengkap berhasil dibuat!', 'success');
                
            } catch (error) {
                showAlert('Gagal membuat laporan lengkap', 'error');
            }
        }

        // Export All Data
        async function exportAllData() {
            showAlert('Mengekspor semua data...', 'warning');
            
            try {
                const [assetsRes, woHistoryRes] = await Promise.all([
                    fetch('/api/assets/detail'),
                    fetch('/api/work_orders/history')
                ]);

                const assets = await assetsRes.json();
                const woHistory = await woHistoryRes.json();

                // Create zip with multiple files
                const timestamp = new Date().toISOString().split('T')[0];
                
                // Export assets
                exportAssetDetail(assets);
                
                // Export WO history
                exportWOHistory(woHistory);
                
                showAlert('Semua data berhasil diexport!', 'success');
                
            } catch (error) {
                showAlert('Gagal mengekspor semua data', 'error');
            }
        }

        // Generate PDF Report
        async function generatePDFReport() {
            const pdfLoading = document.getElementById('pdfLoading');
            pdfLoading.style.display = 'flex';
            
            try {
                // Ensure we have the latest data
                await loadDashboard();
                
                // Wait a moment for charts to render
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                let yPosition = 15;
                
                // Header
                pdf.setFillColor(15, 23, 42);
                pdf.rect(0, 0, pageWidth, 30, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(20);
                pdf.setFont('helvetica', 'bold');
                pdf.text('LAPORAN DASHBOARD', pageWidth / 2, 18, { align: 'center' });
                pdf.setFontSize(10);
                pdf.text('Prime Fragrance Technologies', pageWidth / 2, 25, { align: 'center' });
                
                // Date
                pdf.setTextColor(100, 100, 100);
                pdf.setFontSize(9);
                pdf.text(`Dibuat pada: ${new Date().toLocaleDateString('id-ID', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                })}`, 15, 40);
                
                yPosition = 50;
                
                // KPI Section
                pdf.setFillColor(241, 245, 249);
                pdf.rect(10, yPosition - 5, pageWidth - 20, 15, 'F');
                pdf.setTextColor(15, 23, 42);
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text('KPI UTAMA', 15, yPosition + 3);
                
                yPosition += 20;
                
                // KPI Cards
                const kpiData = [
                    { label: 'MTTR Rata-rata', value: document.getElementById('mttrValue').textContent, icon: '' },
                    { label: 'Kepatuhan PM', value: document.getElementById('pmCompliance').textContent, icon: '' },
                    { label: 'Aset Kritis', value: document.getElementById('problemAsset').textContent, icon: '' },
                    { label: 'WO Aktif', value: document.getElementById('activeWo').textContent, icon: '' }
                ];
                
                const cardWidth = (pageWidth - 40) / 2;
                const cardHeight = 25;
                
                kpiData.forEach((kpi, index) => {
                    const x = 15 + (index % 2) * (cardWidth + 10);
                    const y = yPosition + Math.floor(index / 2) * (cardHeight + 10);
                    
                    pdf.setDrawColor(226, 232, 240);
                    pdf.setFillColor(255, 255, 255);
                    pdf.roundedRect(x, y, cardWidth, cardHeight, 3, 3, 'FD');
                    
                    pdf.setTextColor(100, 116, 139);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(kpi.label.toUpperCase(), x + 10, y + 8);
                    
                    pdf.setTextColor(15, 23, 42);
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(kpi.value, x + 10, y + 16);
                    
                    pdf.setFontSize(14);
                    pdf.text(kpi.icon, x + cardWidth - 15, y + 15);
                });
                
                yPosition += 70;
                
                // Charts Section
                if (yPosition > pageHeight - 50) {
                    pdf.addPage();
                    yPosition = 15;
                }
                
                pdf.setFillColor(241, 245, 249);
                pdf.rect(10, yPosition - 5, pageWidth - 20, 15, 'F');
                pdf.setTextColor(15, 23, 42);
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text('STATISTIK DAN GRAFIK', 15, yPosition + 3);
                
                yPosition += 20;
                
                // Try to capture charts as images
                try {
                    const woChartCanvas = document.getElementById('woChart');
                    const assetChartCanvas = document.getElementById('assetChart');
                    
                    if (woChartCanvas) {
                        const woChartImg = await html2canvas(woChartCanvas, { 
                            scale: 2,
                            useCORS: true,
                            backgroundColor: '#FFFFFF'
                        });
                        
                        const woChartData = woChartImg.toDataURL('image/jpeg', 0.8);
                        pdf.addImage(woChartData, 'JPEG', 15, yPosition, pageWidth - 30, 60);
                    }
                    
                    yPosition += 70;
                    
                    if (assetChartCanvas && yPosition < pageHeight - 60) {
                        const assetChartImg = await html2canvas(assetChartCanvas, { 
                            scale: 2,
                            useCORS: true,
                            backgroundColor: '#FFFFFF'
                        });
                        
                        const assetChartData = assetChartImg.toDataURL('image/jpeg', 0.8);
                        pdf.addImage(assetChartData, 'JPEG', 15, yPosition, pageWidth - 30, 60);
                        yPosition += 70;
                    }
                } catch (error) {
                    console.error("Error capturing charts:", error);
                    pdf.setTextColor(150, 150, 150);
                    pdf.setFontSize(10);
                    pdf.text('Grafik tidak dapat dimuat dalam PDF', 15, yPosition + 10);
                    yPosition += 30;
                }
                
                // Assets Table
                if (yPosition > pageHeight - 100) {
                    pdf.addPage();
                    yPosition = 15;
                }
                
                pdf.setFillColor(241, 245, 249);
                pdf.rect(10, yPosition - 5, pageWidth - 20, 15, 'F');
                pdf.setTextColor(15, 23, 42);
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text('DETAIL ASET PRODUKSI', 15, yPosition + 3);
                
                yPosition += 20;
                
                // Table Header
                pdf.setFillColor(248, 250, 252);
                pdf.rect(15, yPosition, pageWidth - 30, 8, 'F');
                pdf.setTextColor(100, 116, 139);
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'bold');
                pdf.text('NAMA ASET', 17, yPosition + 5);
                pdf.text('LOKASI', 70, yPosition + 5);
                pdf.text('STATUS', 110, yPosition + 5);
                pdf.text('BREAKDOWN', 140, yPosition + 5);
                pdf.text('EFISIENSI', 165, yPosition + 5);
                
                yPosition += 10;
                
                // Table Rows
                pdf.setFontSize(7);
                pdf.setTextColor(51, 65, 85);
                
                currentAssets.slice(0, 15).forEach((asset, index) => {
                    if (yPosition > pageHeight - 15) {
                        pdf.addPage();
                        yPosition = 15;
                        
                        // Repeat header on new page
                        pdf.setFillColor(248, 250, 252);
                        pdf.rect(15, yPosition, pageWidth - 30, 8, 'F');
                        pdf.setTextColor(100, 116, 139);
                        pdf.setFontSize(8);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text('NAMA ASET', 17, yPosition + 5);
                        pdf.text('LOKASI', 70, yPosition + 5);
                        pdf.text('STATUS', 110, yPosition + 5);
                        pdf.text('BREAKDOWN', 140, yPosition + 5);
                        pdf.text('EFISIENSI', 165, yPosition + 5);
                        
                        yPosition += 10;
                    }
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(asset.name.substring(0, 25), 17, yPosition + 5);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(asset.location.substring(0, 20), 70, yPosition + 5);
                    
                    // Status with color coding
                    let statusColor = [16, 185, 129]; // Green for OK
                    if (asset.status === 'Perlu Perhatian') statusColor = [245, 158, 11]; // Yellow
                    if (asset.status === 'Bermasalah') statusColor = [239, 68, 68]; // Red
                    
                    pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                    pdf.text(asset.status.substring(0, 15), 110, yPosition + 5);
                    pdf.setTextColor(51, 65, 85);
                    
                    pdf.text(asset.breakdown_count.toString(), 140, yPosition + 5);
                    
                    const efficiency = parseFloat(asset.efficiency) || 0;
                    pdf.text(efficiency.toFixed(1) + '%', 165, yPosition + 5);
                    
                    yPosition += 6;
                });
                
                // WO History Section
                if (yPosition > pageHeight - 100) {
                    pdf.addPage();
                    yPosition = 15;
                }
                
                pdf.setFillColor(241, 245, 249);
                pdf.rect(10, yPosition - 5, pageWidth - 20, 15, 'F');
                pdf.setTextColor(15, 23, 42);
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text('RIWAYAT WORK ORDER TERBARU', 15, yPosition + 3);
                
                yPosition += 20;
                
                // WO Table Header
                pdf.setFillColor(248, 250, 252);
                pdf.rect(15, yPosition, pageWidth - 30, 8, 'F');
                pdf.setTextColor(100, 116, 139);
                pdf.setFontSize(7);
                pdf.setFont('helvetica', 'bold');
                pdf.text('ASET', 17, yPosition + 5);
                pdf.text('JENIS', 50, yPosition + 5);
                pdf.text('STATUS', 75, yPosition + 5);
                pdf.text('TEKNISI', 95, yPosition + 5);
                pdf.text('DURASI', 130, yPosition + 5);
                
                yPosition += 10;
                
                // WO Table Rows
                pdf.setFontSize(6);
                pdf.setTextColor(51, 65, 85);
                
                currentWOHistory.slice(0, 20).forEach((wo, index) => {
                    if (yPosition > pageHeight - 10) {
                        pdf.addPage();
                        yPosition = 15;
                        
                        // Repeat header on new page
                        pdf.setFillColor(248, 250, 252);
                        pdf.rect(15, yPosition, pageWidth - 30, 8, 'F');
                        pdf.setTextColor(100, 116, 139);
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text('ASET', 17, yPosition + 5);
                        pdf.text('JENIS', 50, yPosition + 5);
                        pdf.text('STATUS', 75, yPosition + 5);
                        pdf.text('TEKNISI', 95, yPosition + 5);
                        pdf.text('DURASI', 130, yPosition + 5);
                        
                        yPosition += 10;
                    }
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(wo.asset_name.substring(0, 20), 17, yPosition + 4);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(wo.type.substring(0, 15), 50, yPosition + 4);
                    
                    // Status with color coding
                    let statusColor = [16, 185, 129]; // Green for Closed
                    if (wo.status === 'Dalam Pengerjaan' || wo.status === 'Ditugaskan') statusColor = [245, 158, 11]; // Yellow
                    if (wo.status === 'Baru') statusColor = [239, 68, 68]; // Red
                    if (wo.status === 'Selesai') statusColor = [59, 130, 246]; // Blue
                    
                    pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                    pdf.text(wo.status.substring(0, 12), 75, yPosition + 4);
                    pdf.setTextColor(51, 65, 85);
                    
                    pdf.text((wo.technician || 'N/A').substring(0, 15), 95, yPosition + 4);
                    pdf.text(wo.duration.substring(0, 10), 130, yPosition + 4);
                    
                    yPosition += 5;
                });
                
                // Footer
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text(`Halaman ${i} dari ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    pdf.text('Prime Fragrance Technologies - Maintenance Management System', pageWidth / 2, pageHeight - 5, { align: 'center' });
                }
                
                // Save PDF
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                pdf.save(`laporan_dashboard_${timestamp}.pdf`);
                
                showAlert('Laporan PDF berhasil dibuat!', 'success');
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                showAlert('Gagal membuat laporan PDF', 'error');
            } finally {
                pdfLoading.style.display = 'none';
            }
        }

        function updateCharts(woStats, dashData) {
            const ctx1 = document.getElementById('woChart').getContext('2d');
            const ctx2 = document.getElementById('assetChart').getContext('2d');

            // WO Bar Chart
            if(woChartInstance) woChartInstance.destroy();
            woChartInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Baru', 'Proses', 'Selesai', 'Ditutup'],
                    datasets: [{
                        label: 'Jumlah WO',
                        data: [woStats.new, woStats.in_progress, woStats.completed, woStats.closed],
                        backgroundColor: ['#F59E0B', '#3B82F6', '#10B981', '#94A3B8'],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });

            // Asset Doughnut Chart
            if(assetChartInstance) assetChartInstance.destroy();
            const nonOperationalAssets = dashData.total_assets - dashData.operational_assets;

            assetChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Operasional', 'Rusak/Down'],
                    datasets: [{
                        data: [dashData.operational_assets, nonOperationalAssets],
                        backgroundColor: ['#0F172A', '#EF4444'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true,
                    cutout: '75%',
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }
                }
            });
        }

        function renderTable(assets) {
            const tbody = document.getElementById('assetTableBody');
            tbody.innerHTML = '';
            
            if (assets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">Tidak ada data aset.</td></tr>';
                return;
            }

            assets.forEach(asset => {
                let badgeClass = 'status-ok';
                if(asset.status === 'Perlu Perhatian') badgeClass = 'status-warn';
                if(asset.status === 'Bermasalah') badgeClass = 'status-err';
                if(asset.status === 'Operasi Normal') badgeClass = 'status-ok';

                const efficiency = parseFloat(asset.efficiency) || 0;

                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:700; color:var(--navy-dark);">${asset.name}</td>
                        <td style="color:var(--text-gray);">${asset.location}</td>
                        <td><span class="status-badge ${badgeClass}">${asset.status}</span></td>
                        <td style="text-align:center; font-weight:700;">${asset.breakdown_count}</td>
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="flex:1; background:#E2E8F0; height:8px; border-radius:4px; overflow:hidden;">
                                    <div style="background:var(--blue-accent); width:${efficiency}%; height:100%;"></div>
                                </div>
                                <span style="font-size:0.85rem; font-weight:700;">${efficiency.toFixed(1)}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // Modal Functions
        function openUserModal() { 
            document.getElementById('userModal').style.display = 'flex'; 
        }
        
        function openAssetModal() { 
            document.getElementById('assetModal').style.display = 'flex'; 
        }
        
        function closeModal(modalId) { 
            document.getElementById(modalId).style.display = 'none'; 
        }

        function openImageModal(imageUrl, title) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModalTitle').textContent = title;
            document.getElementById('imageModal').style.display = 'flex';
        }
        
        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        }

        // User Registration Form
        document.getElementById('regForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = 'Menyimpan...';
            btn.disabled = true;

            const data = {
                name: document.getElementById('regName').value,
                username: document.getElementById('regUsername').value,
                password: document.getElementById('regPass').value,
                role: document.getElementById('regRole').value,
                department: document.getElementById('regDept').value
            };

            try {
                const res = await fetch('/api/admin/register', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(data)
                });
                
                if(res.ok) { 
                    showAlert('User berhasil didaftarkan!', 'success'); 
                    closeModal('userModal');
                    document.getElementById('regForm').reset();
                } else {
                    const msg = await res.json();
                    showAlert('Gagal: ' + msg.message, 'error');
                }
            } catch(err) { 
                showAlert('Terjadi kesalahan koneksi.', 'error'); 
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        // Asset Registration Form
        document.getElementById('assetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = 'Menyimpan...';
            btn.disabled = true;

            const components = document.getElementById('assetComponents').value
                .split(',')
                .map(comp => comp.trim())
                .filter(comp => comp.length > 0);

            const data = {
                name: document.getElementById('assetName').value,
                location: document.getElementById('assetLocation').value,
                type: document.getElementById('assetType').value,
                status: document.getElementById('assetStatus').value,
                critical_components: components
            };

            try {
                // Note: You'll need to create this endpoint in your Flask app
                const res = await fetch('/api/assets/create', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(data)
                });
                
                if(res.ok) { 
                    showAlert('Aset berhasil didaftarkan!', 'success'); 
                    closeModal('assetModal');
                    document.getElementById('assetForm').reset();
                    loadDashboard(); // Refresh data
                } else {
                    const msg = await res.json();
                    showAlert('Gagal: ' + msg.message, 'error');
                }
            } catch(err) { 
                showAlert('Terjadi kesalahan koneksi.', 'error'); 
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        // OEE Functions
        async function calculateOEE() {
            document.getElementById('oeeModal').style.display = 'flex';
            
            // Load assets for selection
            try {
                const response = await fetch('/api/assets');
                const assets = await response.json();
                const select = document.getElementById('oeeAsset');
                select.innerHTML = '<option value="">-- Pilih Aset --</option>';
                assets.forEach(asset => {
                    select.innerHTML += `<option value="${asset.name}">${asset.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading assets:', error);
            }
        }

        async function loadOEEAnalysis() {
            try {
                const response = await fetch('/api/oee/assets');
                const oeeData = await response.json();
                
                // Update OEE chart
                updateOEEChart(oeeData);
                
            } catch (error) {
                console.error('Error loading OEE data:', error);
            }
        }

        function updateOEEChart(oeeData) {
            const ctx = document.getElementById('oeeChart').getContext('2d');
            
            const assets = oeeData.map(item => item.asset_name);
            const oeeValues = oeeData.map(item => item.oee_data?.oee || 0);
            const availability = oeeData.map(item => item.oee_data?.availability || 0);
            const performance = oeeData.map(item => item.oee_data?.performance || 0);
            const quality = oeeData.map(item => item.oee_data?.quality || 0);
            
            if (oeeChartInstance) {
                oeeChartInstance.destroy();
            }
            
            oeeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: assets,
                    datasets: [
                        {
                            label: 'Availability',
                            data: availability,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Performance',
                            data: performance,
                            backgroundColor: 'rgba(255, 206, 86, 0.6)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Quality',
                            data: quality,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'OEE',
                            data: oeeValues,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 2,
                            type: 'line',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Percentage (%)'
                            }
                        }
                    }
                }
            });
        }

        // Risk Assessment Functions
        async function loadRiskAssessment() {
            try {
                const response = await fetch('/api/predictive/risk-assessment');
                const riskData = await response.json();
                
                const container = document.getElementById('riskAssessmentContainer');
                container.innerHTML = '';
                
                if (riskData.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-gray);">Tidak ada data risiko</div>';
                    return;
                }
                
                riskData.forEach(asset => {
                    const riskCard = document.createElement('div');
                    riskCard.className = 'task-card';
                    
                    let riskColor = '#10B981'; // Green for low risk
                    if (asset.risk_level === 'Tinggi') riskColor = '#EF4444';
                    if (asset.risk_level === 'Sedang') riskColor = '#F59E0B';
                    
                    riskCard.innerHTML = `
                        <div class="task-header">
                            <div class="task-asset">${asset.asset_name}</div>
                            <span class="task-prio" style="background: ${riskColor}20; color: ${riskColor};">${asset.risk_level}</span>
                        </div>
                        <div class="task-desc">${asset.recommendation}</div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <i class="fas fa-times-circle"></i>
                                ${asset.breakdown_count} Breakdown
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-bolt"></i>
                                ${asset.efficiency}% Efficiency
                            </div>
                            <div class="meta-item">
                                <i class="far fa-clock"></i>
                                ${asset.last_maintenance}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(riskCard);
                });
                
            } catch (error) {
                console.error('Error loading risk assessment:', error);
            }
        }

        // Energy Monitoring Functions
        function showEnergyModal() {
            document.getElementById('energyModal').style.display = 'flex';
            
            // Load assets for selection
            loadAssetsForSelect('energyAsset');
        }

        async function loadEnergyAnalysis() {
            try {
                const response = await fetch('/api/energy/analysis');
                const energyData = await response.json();
                
                const container = document.getElementById('energyAnalysisContainer');
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-value">${energyData.total_consumption.toFixed(1)}</div>
                                <div class="stat-label">Total kWh (30 hari)</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-value">${energyData.average_power.toFixed(1)}</div>
                                <div class="stat-label">Rata-rata kW</div>
                            </div>
                            <div class="stat-card danger">
                                <div class="stat-value">${energyData.peak_consumption.toFixed(1)}</div>
                                <div class="stat-label">Puncak kW</div>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--navy-dark); margin-bottom: 15px;">Konsumsi per Aset</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #F8FAFC;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border);">Aset</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border);">Total kWh</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border);">Rata-rata kW</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(energyData.assets_analysis).map(([asset, data]) => `
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid var(--border);">${asset}</td>
                                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border);">${data.total_energy.toFixed(1)}</td>
                                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border);">${data.average_power.toFixed(1)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading energy analysis:', error);
            }
        }

        // Cost Analysis Functions
        function showBudgetModal() {
            document.getElementById('budgetModal').style.display = 'flex';
        }

        async function loadCostAnalysis() {
            try {
                const response = await fetch('/api/costs/analysis');
                const costData = await response.json();
                
                const container = document.getElementById('costAnalysisContainer');
                
                // Format currency
                const formatCurrency = (amount) => {
                    return new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: 'IDR',
                        minimumFractionDigits: 0
                    }).format(amount);
                };
                
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-value">${formatCurrency(costData.total_costs)}</div>
                                <div class="stat-label">Total Biaya (12 bulan)</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-value">${formatCurrency(costData.cost_per_wo)}</div>
                                <div class="stat-label">Rata-rata per WO</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <h4 style="color: var(--navy-dark); margin-bottom: 15px;">Biaya per Tipe</h4>
                                <table style="width: 100%; border-collapse: collapse;">
                                    ${Object.entries(costData.costs_by_type).map(([type, amount]) => `
                                        <tr>
                                            <td style="padding: 8px; border-bottom: 1px solid var(--border);">${type}</td>
                                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid var(--border);">${formatCurrency(amount)}</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </div>
                            
                            <div>
                                <h4 style="color: var(--navy-dark); margin-bottom: 15px;">Biaya per Aset</h4>
                                <table style="width: 100%; border-collapse: collapse;">
                                    ${Object.entries(costData.costs_by_asset).map(([asset, amount]) => `
                                        <tr>
                                            <td style="padding: 8px; border-bottom: 1px solid var(--border);">${asset}</td>
                                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid var(--border);">${formatCurrency(amount)}</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading cost analysis:', error);
            }
        }

        // Utility function to load assets for select elements
        async function loadAssetsForSelect(selectId) {
            try {
                const response = await fetch('/api/assets');
                const assets = await response.json();
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- Pilih Aset --</option>';
                assets.forEach(asset => {
                    select.innerHTML += `<option value="${asset.name}">${asset.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading assets:', error);
            }
        }

        // Form submissions for new features
        document.getElementById('oeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                asset_name: document.getElementById('oeeAsset').value,
                planned_production_time: parseFloat(document.getElementById('plannedTime').value),
                actual_production_time: parseFloat(document.getElementById('actualTime').value),
                ideal_cycle_time: parseFloat(document.getElementById('cycleTime').value),
                total_units: parseInt(document.getElementById('totalUnits').value),
                good_units: parseInt(document.getElementById('goodUnits').value)
            };
            
            try {
                const response = await fetch('/api/oee/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert(`OEE berhasil dihitung: ${result.oee}%`, 'success');
                    closeModal('oeeModal');
                    loadOEEAnalysis();
                } else {
                    const error = await response.json();
                    showAlert('Gagal menghitung OEE: ' + error.message, 'error');
                }
            } catch (error) {
                showAlert('Error menghitung OEE: ' + error.message, 'error');
            }
        });

        document.getElementById('energyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                asset_name: document.getElementById('energyAsset').value,
                energy_consumption: parseFloat(document.getElementById('energyConsumption').value),
                duration_hours: parseFloat(document.getElementById('energyDuration').value),
                timestamp: Math.floor(new Date(document.getElementById('energyTimestamp').value).getTime() / 1000)
            };
            
            try {
                const response = await fetch('/api/energy/consumption', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showAlert('Data konsumsi energi berhasil dicatat', 'success');
                    closeModal('energyModal');
                    loadEnergyAnalysis();
                } else {
                    const error = await response.json();
                    showAlert('Gagal mencatat data energi: ' + error.message, 'error');
                }
            } catch (error) {
                showAlert('Error mencatat data energi: ' + error.message, 'error');
            }
        });

        document.getElementById('budgetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                year: parseInt(document.getElementById('budgetYear').value),
                quarter: parseInt(document.getElementById('budgetQuarter').value),
                amount: parseFloat(document.getElementById('budgetAmount').value),
                department: document.getElementById('budgetDepartment').value
            };
            
            try {
                const response = await fetch('/api/costs/budget', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showAlert('Budget berhasil ditetapkan', 'success');
                    closeModal('budgetModal');
                    loadCostAnalysis();
                } else {
                    const error = await response.json();
                    showAlert('Gagal menetapkan budget: ' + error.message, 'error');
                }
            } catch (error) {
                showAlert('Error menetapkan budget: ' + error.message, 'error');
            }
        });

        // Load Initial Data
        loadDashboard();
        
        // Auto Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>